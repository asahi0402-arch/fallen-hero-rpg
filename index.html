<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>堕ちた英雄</title>
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAA==">
    <link rel="stylesheet" href="style.css?v=20250824_fix2">
</head>
<body>
    <div class="game-container">
        <!-- 新しいゲーム画面レイアウト -->
        <div class="game-main">
            <!-- 左エリア：主人公立ち絵 -->
            <div class="player-portrait-area">
                <!-- プレイヤー画像/動画コンテナ -->
                <div id="playerMediaContainer" class="player-portrait">
                    <!-- プレイヤー画像は JavaScript で動的に生成されます -->
                </div>
                
                <!-- プレイヤーステータス（立ち絵下に移動） -->
                <div class="player-stats-left">
                    <div class="stat-title" id="playerName">主人公</div>
                    <div class="level-display">
                        <div class="stat-item-left level-item">レベル: <span id="playerLevel">1</span></div>
                    </div>
                    <div class="detailed-stats-left">
                        <div class="stat-item-left">攻撃: <span id="playerAttack">20</span></div>
                        <div class="stat-item-left">防御: <span id="playerDefense">10</span></div>
                        <div class="stat-item-left">魔力: <span id="playerMagic">15</span></div>
                        <div class="stat-item-left">素早: <span id="playerSpeed">12</span></div>
                    </div>
                    
                    <!-- 装備表示 -->
                    <div class="player-equipment">
                        <div class="equipment-title">装備</div>
                        <div class="equipment-grid">
                            <div class="equipment-slot">
                                <div class="equipment-label">武器</div>
                                <div class="equipment-name" id="equippedWeapon">なし</div>
                            </div>
                            <div class="equipment-slot">
                                <div class="equipment-label">盾</div>
                                <div class="equipment-name" id="equippedShield">なし</div>
                            </div>
                            <div class="equipment-slot">
                                <div class="equipment-label">頭</div>
                                <div class="equipment-name" id="equippedHead">なし</div>
                            </div>
                            <div class="equipment-slot">
                                <div class="equipment-label">胴</div>
                                <div class="equipment-name" id="equippedBody">なし</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 経験値と所持金 -->
                    <div class="player-resources">
                        <div class="resource-item">
                            <span class="resource-label">経験値:</span>
                            <span class="resource-value" id="playerExp">0</span>
                            <span class="resource-next">/ <span id="nextLevelExp">20</span></span>
                        </div>
                        <div class="resource-item">
                            <span class="resource-label">所持金:</span>
                            <span class="resource-value" id="playerGold">100</span>
                            <span class="resource-unit">G</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 中央エリア：敵キャラクター -->
            <div class="enemy-area">
                <!-- 背景画像（敵エリア全体の背景） -->
                <div class="stage-background">
                    <img id="stageBackground" src="./assets/images/backgrounds/plains_bg.jpg" alt="ステージ背景" class="background-image"
                         onerror="this.style.backgroundColor='#87CEEB'; this.innerHTML='<div class=\'placeholder-text\'>背景</div>'">
                </div>
                
                <div class="enemy-container">
                    <!-- 敵キャラ（背景の前に配置） -->
                    <img id="enemyImage" src="./assets/images/enemies/slime.png" alt="敵キャラ" class="enemy-image" 
                         onerror="this.style.backgroundColor='#FF6BF5'; this.innerHTML='<div class=\'placeholder-text\'>敵</div>'">
                    
                    <!-- 攻撃エフェクト（剣で切る） -->
                    <div class="attack-effect" id="attackEffect">
                        <div class="slash-line slash-1"></div>
                        <div class="slash-line slash-2"></div>
                        <div class="slash-sparkles">
                            <div class="sparkle sparkle-1">✦</div>
                            <div class="sparkle sparkle-2">✧</div>
                            <div class="sparkle sparkle-3">✦</div>
                        </div>
                    </div>
                    
                    <!-- 敵情報（敵画像の上に小さく表示） -->
                    <div class="enemy-info-overlay">
                        <div class="enemy-name" id="enemyName">スライム</div>
                        <div class="enemy-hp-bar">
                            <div class="hp-bar-bg">
                                <div class="hp-bar-fill" id="enemyHpBar" style="width: 100%"></div>
                            </div>
                            <div class="hp-text" id="enemyHpText">50/50</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右エリア：章情報＋ショップ -->
            <div class="right-panel">
                <!-- 章情報（右に移動） -->
                <div class="chapter-info-right">
                    <div class="battle-info">
                        <span id="chapterDisplay">1章</span> - 戦闘 <span id="battleCount">1</span>/<span id="maxBattles">10</span>
                    </div>
                </div>
                
                <!-- フィールド/ダンジョン選択 -->
                <div class="location-selection">
                    <div class="location-label">探索場所</div>
                    <div class="location-buttons">
                        <button class="location-btn active" id="fieldBtn">フィールド</button>
                        <button class="location-btn" id="dungeonBtn">ダンジョン</button>
                    </div>
                    <div class="location-info" id="locationInfo">フィールドで安全に戦闘</div>
                </div>

                <!-- ギルドエリア -->
                <div class="guild-section">
                    <button class="guild-btn" id="guildBtn" title="仲間との会話やクエスト情報を確認できます">
                        <span class="btn-text">🏛️ ギルド</span>
                    </button>
                </div>

                <!-- 宿屋エリア -->
                <div class="inn-section">
                    <button class="inn-btn" id="innBtn" title="100ゴールドでHP/MPを全回復します（フィールドからのみ利用可能）">
                        <span class="btn-text">🏨 宿屋</span>
                    </button>
                </div>

                <!-- 酒場エリア -->
                <div class="tavern-section">
                    <button class="tavern-btn" id="tavernBtn" title="ゴールドで仲間を雇ったり、キャラクターを切り替えることができます">
                        <span class="btn-text">🍺 酒場</span>
                    </button>
                </div>

                <!-- ショップエリア -->
                <div class="shop-section">
                    <button class="shop-btn" id="shopBtn" title="アイテムの購入・売却・衣服の修理ができます">
                        <span class="btn-text">🏪 ショップ</span>
                    </button>
                </div>

                <!-- ガチャショップエリア -->
                <div class="gacha-section">
                    <button class="gacha-btn" id="gachaShopBtn" title="ゴールドで装備ガチャ・イラストガチャを引くことができます">
                        <span class="btn-text">🎰 ガチャ</span>
                    </button>
                </div>

                <!-- セーブエリア -->
                <div class="save-section">
                    <button class="save-btn" id="saveBtn" title="現在の進行状況を保存します（街でのみ利用可能）">
                        <span class="btn-text">💾 セーブ</span>
                    </button>
                </div>

                <!-- オプションエリア -->
                <div class="options-section">
                    <button class="options-btn" id="optionsBtn" title="ゲームの設定を変更できます">
                        <span class="btn-text">⚙️ オプション</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 下部：プレイヤーコントロール＋戦闘ログ -->
        <div class="bottom-controls">
            <!-- 左側：プレイヤーHP/MPとコマンド -->
            <div class="player-controls-left">
                <div class="player-bars-bottom">
                    <div class="player-bar-column">
                        <span class="bar-label">プレイヤーHP</span>
                        <span class="bar-value" id="playerHpText">100/100</span>
                        <div class="hp-bar-bg">
                            <div class="hp-bar-fill player-hp" id="playerHpBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="player-bar-column">
                        <span class="bar-label">プレイヤーMP</span>
                        <span class="bar-value" id="playerMpText">30/30</span>
                        <div class="mp-bar-bg">
                            <div class="mp-bar-fill" id="playerMpBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="status-effects-area">
                        <span class="status-label">状態</span>
                        <div class="status-effects" id="playerStatusEffects">
                            <!-- 状態異常がある時のみ表示される -->
                        </div>
                    </div>
                </div>
                
                <!-- コマンドエリア -->
                <div class="command-section-bottom">
                    <div class="command-buttons-bottom">
                        <button class="command-btn attack-btn" id="attackBtn">攻撃</button>
                        <button class="command-btn skill-btn" id="skillBtn">スキル</button>
                        <button class="command-btn item-btn" id="itemBtn">アイテム</button>
                        <button class="command-btn flee-btn" id="fleeBtn">逃げる</button>
                        <button class="command-btn auto-btn" id="autoBtn">オート</button>
                    </div>
                </div>
            </div>
            
            <!-- 右側：戦闘ログ -->
            <div class="battle-log-right">
                <div class="log-header">戦闘ログ</div>
                <div class="log-content" id="battleLogContent">
                    <div class="log-entry">戦闘が開始されました</div>
                    <div class="log-entry">プレイヤーの攻撃！</div>
                    <div class="log-entry">スライムに15ダメージ</div>
                </div>
            </div>
        </div>


        <!-- スキル選択モーダル -->
        <div class="modal" id="skillModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>スキル選択</h3>
                    <button class="close-btn" id="closeSkillModal">&times;</button>
                </div>
                <div class="skill-list">
                    <button class="skill-option" data-skill="fireball">
                        <div class="skill-name">ファイアボール</div>
                        <div class="skill-cost">MP: 10</div>
                        <div class="skill-desc">炎属性の魔法攻撃</div>
                    </button>
                    <button class="skill-option" data-skill="heal">
                        <div class="skill-name">ヒール</div>
                        <div class="skill-cost">MP: 8</div>
                        <div class="skill-desc">HPを回復する</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- アイテム選択モーダル -->
        <div class="modal" id="itemModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>アイテム使用</h3>
                    <button class="close-btn" id="closeItemModal">&times;</button>
                </div>
                <div class="equipment-error" id="equipmentError" style="display: none;">
                    <span id="equipmentErrorText"></span>
                </div>
                <div class="item-list" id="itemList">
                    <!-- アイテムが動的に生成される -->
                </div>
            </div>
        </div>

        <!-- ショップモーダル -->
        <div class="modal" id="shopModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🏪 アイテムショップ</h3>
                    <button class="close-btn" id="closeShopModal">&times;</button>
                </div>
                <div class="shop-tabs">
                    <button class="shop-tab active" id="buyTab">購入</button>
                    <button class="shop-tab" id="sellTab">売却</button>
                    <button class="shop-tab" id="repairTab">修理</button>
                </div>
                <div class="shop-info">
                    <div class="player-gold">所持金: <span id="shopPlayerGold">100</span>G</div>
                </div>
                <div class="shop-content">
                    <div class="shop-items" id="shopItemsList">
                        <!-- ショップアイテムが動的に生成される -->
                    </div>
                    <div class="sell-items" id="sellItemsList" style="display: none;">
                        <!-- 売却可能アイテムが動的に生成される -->
                    </div>
                    <div class="repair-items" id="repairItemsList" style="display: none;">
                        <!-- 修理メニューが動的に生成される -->
                    </div>
                </div>
            </div>
        </div>

        <!-- オートモード設定モーダル -->
        <div class="modal" id="autoModeSettingsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>⚙️ オートモード設定</h3>
                    <button class="close-btn" onclick="closeAutoSettingsModal()">&times;</button>
                </div>
                <div class="auto-settings">
                    <h4>レベルアップ時の動作</h4>
                    <div class="setting-option">
                        <input type="radio" id="autoLevelUpManual" name="autoLevelUp" value="manual" checked>
                        <label for="autoLevelUpManual">戦闘を中断してレベルアップ画面を表示</label>
                    </div>
                    <div class="setting-option">
                        <input type="radio" id="autoLevelUpRandom" name="autoLevelUp" value="random">
                        <label for="autoLevelUpRandom">自動でランダムにステータスポイントを割り振り</label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button onclick="startAutoModeWithSettings()" class="confirm-btn">オート開始</button>
                    <button onclick="closeAutoSettingsModal()" class="cancel-btn">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- レベルアップモーダル -->
        <div class="modal" id="levelUpModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🎉 レベルアップ！</h3>
                </div>
                <div class="level-up-info">
                    <div class="level-display">Level <span id="levelUpDisplay">2</span>になりました！</div>
                    <div class="stat-points">ステータスポイント: <span id="availablePoints">3</span></div>
                </div>
                <div class="stat-allocation">
                    <div class="stat-group">
                        <div class="stat-row">
                            <span class="stat-label">HP</span>
                            <button class="stat-btn minus" data-stat="maxHp" data-type="minus">-</button>
                            <span class="stat-current" id="statHp">100</span>
                            <button class="stat-btn plus" data-stat="maxHp" data-type="plus">+</button>
                            <span class="stat-effect">(+10)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">MP</span>
                            <button class="stat-btn minus" data-stat="maxMp" data-type="minus">-</button>
                            <span class="stat-current" id="statMp">30</span>
                            <button class="stat-btn plus" data-stat="maxMp" data-type="plus">+</button>
                            <span class="stat-effect">(+10)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">攻撃</span>
                            <button class="stat-btn minus" data-stat="attack" data-type="minus">-</button>
                            <span class="stat-current" id="statAttack">20</span>
                            <button class="stat-btn plus" data-stat="attack" data-type="plus">+</button>
                            <span class="stat-effect">(+1)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">防御</span>
                            <button class="stat-btn minus" data-stat="defense" data-type="minus">-</button>
                            <span class="stat-current" id="statDefense">10</span>
                            <button class="stat-btn plus" data-stat="defense" data-type="plus">+</button>
                            <span class="stat-effect">(+1)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">魔力</span>
                            <button class="stat-btn minus" data-stat="magic" data-type="minus">-</button>
                            <span class="stat-current" id="statMagic">15</span>
                            <button class="stat-btn plus" data-stat="magic" data-type="plus">+</button>
                            <span class="stat-effect">(+1)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">素早</span>
                            <button class="stat-btn minus" data-stat="speed" data-type="minus">-</button>
                            <span class="stat-current" id="statSpeed">12</span>
                            <button class="stat-btn plus" data-stat="speed" data-type="plus">+</button>
                            <span class="stat-effect">(+1)</span>
                        </div>
                    </div>
                </div>
                <div class="level-up-actions">
                    <button class="confirm-btn" id="confirmLevelUp">決定</button>
                </div>
            </div>
        </div>

        <!-- ギルドモーダル -->
        <div class="modal" id="guildModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🏛️ ギルド</h3>
                    <button class="close-btn" id="closeGuildModal">&times;</button>
                </div>
                <div class="guild-content">
                    <div class="conversation-area">
                        <div class="conversation-log" id="conversationLog">
                            <p class="guild-message">「冒険者よ、よく来た。ここは冒険者ギルドだ。」</p>
                        </div>
                        <div class="conversation-choices" id="conversationChoices">
                            <button class="choice-btn" onclick="showConversationChoice('quest')">依頼について聞く</button>
                            <button class="choice-btn" onclick="showConversationChoice('party')">パーティについて聞く</button>
                            <button class="choice-btn" onclick="showConversationChoice('info')">情報を聞く</button>
                            <button class="choice-btn" onclick="closeModal('guildModal')">立ち去る</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 酒場モーダル -->
        <div class="modal" id="tavernModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🍺 酒場</h3>
                    <button class="close-btn" id="closeTavernModal">&times;</button>
                </div>
                <div class="tavern-info">
                    <div class="player-gold">所持金: <span id="tavernPlayerGold">100</span>G</div>
                </div>
                <div class="tavern-tabs">
                    <button class="tavern-tab active" id="purchaseTab">キャラクター雇用</button>
                    <button class="tavern-tab" id="switchTab">キャラクター切り替え</button>
                </div>
                <div class="tavern-content">
                    <div class="available-characters" id="availableCharactersList">
                        <!-- 購入可能なキャラクターが動的に生成される -->
                    </div>
                    <div class="owned-characters" id="ownedCharactersList" style="display: none;">
                        <!-- 所有しているキャラクターが動的に生成される -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ガチャショップモーダル -->
        <div class="modal" id="gachaModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🎰 ガチャショップ</h3>
                    <button class="close-btn" id="closeGachaModal">&times;</button>
                </div>
                
                <!-- ガチャ結果表示エリア -->
                <div class="gacha-results" id="gachaResults" style="display: none;">
                    <div class="gacha-results-header">獲得アイテム</div>
                    <div class="gacha-results-list" id="gachaResultsList">
                    </div>
                </div>
                
                <div class="gacha-menu">
                    <div class="gacha-type-section">
                        <h4>⚔️ アイテムガチャ</h4>
                        <p class="gacha-description">武器・防具・アクセサリーが手に入る</p>
                        <div class="gacha-buttons">
                            <button class="gacha-action-btn" id="equipmentGacha1">
                                <span class="gacha-text">1回</span>
                                <span class="gacha-cost">500G</span>
                            </button>
                            <button class="gacha-action-btn" id="equipmentGacha10">
                                <span class="gacha-text">10連</span>
                                <span class="gacha-cost">4500G</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="gacha-type-section">
                        <h4>🖼️ イラストガチャ</h4>
                        <p class="gacha-description">キャラクターイラストが手に入る</p>
                        <div class="gacha-buttons">
                            <button class="gacha-action-btn" id="illustrationGacha1">
                                <span class="gacha-text">1回</span>
                                <span class="gacha-cost">100G</span>
                            </button>
                            <button class="gacha-action-btn" id="illustrationGacha10">
                                <span class="gacha-text">10連</span>
                                <span class="gacha-cost">900G</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="gacha-info">
                        <div class="player-gold">所持金: <span id="gachaPlayerGold">100</span>G</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- オプションモーダル -->
        <div class="modal" id="optionsModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>⚙️ オプション</h3>
                    <button class="close-btn" id="closeOptionsModal">&times;</button>
                </div>
                <div class="options-content">
                    <!-- BGM音量調整 -->
                    <div class="option-section">
                        <h4>🎵 BGM音量</h4>
                        <div class="volume-control">
                            <input type="range" id="bgmVolumeSlider" min="0" max="100" value="50" class="volume-slider">
                            <span id="bgmVolumeValue">50%</span>
                        </div>
                    </div>
                    
                    <!-- SE音量調整 -->
                    <div class="option-section">
                        <h4>🔊 SE音量</h4>
                        <div class="volume-control">
                            <input type="range" id="seVolumeSlider" min="0" max="100" value="50" class="volume-slider">
                            <span id="seVolumeValue">50%</span>
                        </div>
                    </div>
                    
                    <!-- タイトルへ戻る -->
                    <div class="option-section">
                        <button class="return-title-btn" id="returnToTitleBtn">
                            🏠 タイトルへ戻る
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- ゲーム風確認モーダル -->
    <div class="game-confirm-modal" id="gameConfirmModal" style="display: none;">
        <div class="game-confirm-content">
            <div class="game-confirm-header">
                <h3 id="gameConfirmTitle">確認</h3>
            </div>
            <div class="game-confirm-body">
                <p id="gameConfirmMessage">実行しますか？</p>
            </div>
            <div class="game-confirm-buttons">
                <button class="game-btn game-btn-primary" id="gameConfirmYes">はい</button>
                <button class="game-btn game-btn-secondary" id="gameConfirmNo">いいえ</button>
            </div>
        </div>
    </div>

    <script src="data_manager.js?v=20250826_fix1"></script>
    <script src="story_trigger.js"></script>
    <script src="script.js?v=20250826_fix1"></script>
</body>
</html>